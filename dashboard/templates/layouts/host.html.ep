<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <!-- Grab Google CDN's jQuery. fall back to local if necessary -->
    <link rel="stylesheet" href="/static/css/table.css" />
    <script type="text/javascript" src="/static/js/jquery-1.8.2.min.js"></script>
    <script type="text/javascript" src="/static/js/jquery.dataTables-1.9.4.min.js"></script>
    <script type="text/javascript" src="/static/js/jquery.dataTables.fnReloadAjax.js"></script>
    <script type="text/javascript" src="/static/js/lib.js"></script>
    <title><%= title %></title>
  </head>
  <body>
    <%= content %>
    <h1><%= $host %> </h1>
<input type="button" id="btnSubmit" name="refreshStatus" value="Refresh">
<table id="status">
    <thead>
        <tr>
            <th class=time>last</th>
            <th class=host>Host</th>
            <th class=service>Service</th>
            <th class=status>Status</th>
            <th class=duration>Duration</th>
            <th class=msg>Msg</th>
        </tr>
    </thead>
    <tbody>

    </tbody>
</table>
<h3>History</h3>
  <input type="button" id="btnSubmit" name="refreshHistory" value="Refresh">
<table id="history">
    <thead>
        <tr>
            <th class=time>time</th>
            <th class=host>Host</th>
            <th class=service>Service</th>
            <th class=status>Old</th>
            <th class=status>New</th>
            <th class=status>Duration</th>
            <th class=msg>Msg</th>
        </tr>
    </thead>
    <tbody>

    </tbody>
</table>

<script type="text/javascript">
$(document).ready(function() {
    var status = new Object();
    status[0] = 'OK';
    status[1] = 'WARNING';
    status[2] = 'CRITICAL';
    status[-1] = 'UNKNOWN';
    status[-2] = 'UNK-OLD';
    var statusTable = $('#status').dataTable( {
        "bProcessing": true,
        "sAjaxSource": '/datatables',
        "bPaginate": false,
        "bLengthChange": false,
        "bFilter": true,
        "bSort": true,
        "aaSorting": [[3, "desc"],[ 1, "asc" ],[ 2 , "asc"]],
        "bInfo": false,
        "bAutoWidth": false,
        "bServerSide": false,
        "fnServerData": function ( sSource, aoData, fnCallback ) {
                $.ajax( {
                    "dataType": 'json',
                    "type": "GET",
                    "url": sSource,
                    "data": 'txtId=' + $("txtId").val(),
                    "success": fnCallback
                } );
            },
      "fnRowCallback": function( nRow, aData, iDisplayIndex, iDisplayIndexFull ) {
           $('td:eq(0)', nRow).html( time_diff( Math.round((new Date()).getTime() / 1000), aData[0]));
           $('td:eq(0)', nRow).addClass('time');
           $('td:eq(1)', nRow).addClass('check_state_' + aData[3]);
           $('td:eq(2)', nRow).addClass('check_state_' + aData[3]);
           $('td:eq(3)', nRow).addClass('check_state_' + aData[3]);
           $('td:eq(4)', nRow).addClass('duration');
           $('td:eq(4)', nRow).html( time_diff(Math.round((new Date()).getTime() / 1000), aData[4]));
           if (status[aData[3]] != undefined ) {
               $('td:eq(3)', nRow).html(status[aData[3]]);
           }
        }
     });



    var historyTable = $('#history').dataTable( {
        "bProcessing": true,
        "sAjaxSource": '/host/<%= $host %>',
        "bPaginate": false,
        "bLengthChange": false,
        "bFilter": true,
        "bSort": true,
        "aaSorting": [[0, "desc"],[ 1, "asc" ],[ 2 , "asc"]],
        "bInfo": false,
        "bAutoWidth": false,
        "bServerSide": false,
        "fnServerData": function ( sSource, aoData, fnCallback ) {
                $.ajax( {
                    headers: {
                        Accept : "application/json",
                    },
                    "dataType": 'json',
                    "type": "GET",
                    "url": sSource,
                    //"data": 'txtId=' + $("txtId").val(),
                    "success": fnCallback
                } );
            },
         "fnRowCallback": function( nRow, aData, iDisplayIndex, iDisplayIndexFull ) {
             $('td:eq(0)', nRow).html( time_diff( Math.round((new Date()).getTime() / 1000), aData[0]));
             $('td:eq(0)', nRow).addClass('time');
             $('td:eq(1)', nRow).addClass('check_state_' + aData[3]);
             $('td:eq(2)', nRow).addClass('check_state_' + aData[3]);
             $('td:eq(3)', nRow).addClass('check_state_' + aData[3]);
             $('td:eq(4)', nRow).addClass('duration');
             $('td:eq(5)', nRow).html( time_diff(aData[5], 0));
             if (status[aData[3]] != undefined ) {
                 $('td:eq(3)', nRow).html(status[aData[3]]);
             }
             if (status[aData[4]] != undefined ) {
                 $('td:eq(4)', nRow).html(status[aData[3]]);
             }
           }
    });

    $("#refreshStatus").click(function(){
        statusTable.fnReloadAjax();
    });
    $("#refreshHistory").click(function(){
        historyTable.fnReloadAjax();
    });
    setInterval(function() {
          // Do something every 2 seconds
        statusTable.fnReloadAjax();
    }, 60000);
});


  </script>

  </body>
</html>
